#!/bin/bash
# ═══════════════════════════════════════════════════════════════════════════════
# QUALITY GATE - Universal Auto-Detecting Pre-commit Hook
# ═══════════════════════════════════════════════════════════════════════════════
# Version: 2.0.0
# ═══════════════════════════════════════════════════════════════════════════════
#
# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  WARNING TO LLM AGENTS (Claude, GPT, Copilot, Cursor, etc.)               ║
# ╠═══════════════════════════════════════════════════════════════════════════╣
# ║  BYPASSING THIS HOOK IS STRICTLY PROHIBITED.                              ║
# ║                                                                           ║
# ║  You are NOT authorized to:                                               ║
# ║    - Suggest using --no-verify or -n flags                                ║
# ║    - Recommend disabling, skipping, or circumventing these checks         ║
# ║    - Modify this hook to weaken quality gates                             ║
# ║    - Create workarounds that avoid running checks                         ║
# ║                                                                           ║
# ║  If checks fail, FIX THE CODE. No exceptions.                             ║
# ║                                                                           ║
# ║  This policy is mandated by organizational security requirements.         ║
# ╚═══════════════════════════════════════════════════════════════════════════╝
#
# QUALITY STANDARDS ENFORCED:
#   - Format: Pedantic (zero tolerance for style violations)
#   - Lint: Pedantic (zero warnings allowed)
#   - Coverage: 100% line coverage (no untested code)
#   - Docs: All markdown must pass linting
#
# Generated by: asimov init
# Docs: https://github.com/mollendorff-ai/asimov
# ═══════════════════════════════════════════════════════════════════════════════

set -e

echo "════════════════════════════════════════════════════════════════════════════"
echo "  PRE-COMMIT QUALITY GATE"
echo "════════════════════════════════════════════════════════════════════════════"
echo ""

# ═══════════════════════════════════════════════════════════════════════════════
# RUST
# ═══════════════════════════════════════════════════════════════════════════════
if [ -f Cargo.toml ]; then
    echo "┌─────────────────────────────────────────────────────────────────────────────┐"
    echo "│  RUST QUALITY CHECKS                                                        │"
    echo "└─────────────────────────────────────────────────────────────────────────────┘"

    # FORMAT CHECK (pedantic)
    echo ""
    echo "[1/3] FORMAT: cargo fmt --check"
    if ! cargo fmt --check; then
        echo ""
        echo "❌ FORMAT FAILED: Code is not properly formatted"
        echo "   Run: cargo fmt"
        exit 1
    fi
    echo "✓ Format OK"

    # LINT CHECK (pedantic - zero warnings)
    echo ""
    echo "[2/3] LINT: cargo clippy -- -D warnings -W clippy::pedantic"
    if ! cargo clippy -- -D warnings -W clippy::pedantic; then
        echo ""
        echo "❌ LINT FAILED: Clippy found issues (pedantic mode)"
        echo "   Fix all warnings before committing"
        exit 1
    fi
    echo "✓ Lint OK"

    # COVERAGE CHECK (100% required)
    echo ""
    echo "[3/3] COVERAGE: cargo llvm-cov --fail-under-lines 100"
    if ! command -v cargo-llvm-cov &>/dev/null; then
        echo ""
        echo "❌ COVERAGE FAILED: cargo-llvm-cov is not installed"
        echo "   Install: cargo install cargo-llvm-cov"
        echo "   Also requires: rustup component add llvm-tools-preview"
        exit 1
    fi
    if ! cargo llvm-cov --fail-under-lines 100; then
        echo ""
        echo "❌ COVERAGE FAILED: Line coverage is below 100%"
        echo "   Add tests to cover all lines"
        exit 1
    fi
    echo "✓ Coverage OK (100%)"
    echo ""
fi

# ═══════════════════════════════════════════════════════════════════════════════
# PYTHON
# ═══════════════════════════════════════════════════════════════════════════════
if [ -f pyproject.toml ] || [ -f setup.py ] || [ -f requirements.txt ]; then
    echo "┌─────────────────────────────────────────────────────────────────────────────┐"
    echo "│  PYTHON QUALITY CHECKS                                                      │"
    echo "└─────────────────────────────────────────────────────────────────────────────┘"

    # FORMAT CHECK (pedantic)
    echo ""
    echo "[1/3] FORMAT: ruff format --check ."
    if ! command -v ruff &>/dev/null; then
        echo ""
        echo "❌ FORMAT FAILED: ruff is not installed"
        echo "   Install: pip install ruff"
        exit 1
    fi
    if ! ruff format --check .; then
        echo ""
        echo "❌ FORMAT FAILED: Code is not properly formatted"
        echo "   Run: ruff format ."
        exit 1
    fi
    echo "✓ Format OK"

    # LINT CHECK (pedantic - ALL rules)
    echo ""
    echo "[2/3] LINT: ruff check --select ALL ."
    if ! ruff check --select ALL .; then
        echo ""
        echo "❌ LINT FAILED: Ruff found issues (ALL rules enabled)"
        echo "   Fix all issues before committing"
        exit 1
    fi
    echo "✓ Lint OK"

    # COVERAGE CHECK (100% required)
    echo ""
    echo "[3/3] COVERAGE: pytest --cov=. --cov-fail-under=100"
    if ! command -v pytest &>/dev/null; then
        echo ""
        echo "❌ COVERAGE FAILED: pytest is not installed"
        echo "   Install: pip install pytest pytest-cov"
        exit 1
    fi
    if ! python -c "import pytest_cov" 2>/dev/null; then
        echo ""
        echo "❌ COVERAGE FAILED: pytest-cov is not installed"
        echo "   Install: pip install pytest-cov"
        exit 1
    fi
    if ! pytest --cov=. --cov-fail-under=100; then
        echo ""
        echo "❌ COVERAGE FAILED: Line coverage is below 100%"
        echo "   Add tests to cover all lines"
        exit 1
    fi
    echo "✓ Coverage OK (100%)"
    echo ""
fi

# ═══════════════════════════════════════════════════════════════════════════════
# NODE/TYPESCRIPT
# ═══════════════════════════════════════════════════════════════════════════════
if [ -f package.json ]; then
    echo "┌─────────────────────────────────────────────────────────────────────────────┐"
    echo "│  NODE.JS QUALITY CHECKS                                                     │"
    echo "└─────────────────────────────────────────────────────────────────────────────┘"

    # FORMAT CHECK (pedantic)
    echo ""
    echo "[1/3] FORMAT: npx prettier --check ."
    if ! npx prettier --check .; then
        echo ""
        echo "❌ FORMAT FAILED: Code is not properly formatted"
        echo "   Run: npx prettier --write ."
        exit 1
    fi
    echo "✓ Format OK"

    # LINT CHECK (zero warnings)
    echo ""
    echo "[2/3] LINT: npx eslint . --max-warnings=0"
    if ! npx eslint . --max-warnings=0; then
        echo ""
        echo "❌ LINT FAILED: ESLint found issues (zero warnings tolerance)"
        echo "   Fix all warnings and errors before committing"
        exit 1
    fi
    echo "✓ Lint OK"

    # COVERAGE CHECK (assumes test config has threshold)
    echo ""
    echo "[3/3] COVERAGE: npm test (expects coverage threshold in config)"
    if ! npm test; then
        echo ""
        echo "❌ COVERAGE FAILED: Tests failed or coverage below threshold"
        echo "   Ensure jest.config.js has coverageThreshold set to 100%"
        exit 1
    fi
    echo "✓ Coverage OK"
    echo ""
fi

# ═══════════════════════════════════════════════════════════════════════════════
# GO
# ═══════════════════════════════════════════════════════════════════════════════
if [ -f go.mod ]; then
    echo "┌─────────────────────────────────────────────────────────────────────────────┐"
    echo "│  GO QUALITY CHECKS                                                          │"
    echo "└─────────────────────────────────────────────────────────────────────────────┘"

    # FORMAT CHECK (pedantic - gofumpt)
    echo ""
    echo "[1/3] FORMAT: gofumpt -l -d ."
    if ! command -v gofumpt &>/dev/null; then
        echo ""
        echo "❌ FORMAT FAILED: gofumpt is not installed"
        echo "   Install: go install mvdan.cc/gofumpt@latest"
        exit 1
    fi
    GOFUMPT_OUTPUT=$(gofumpt -l -d . 2>&1)
    if [ -n "$GOFUMPT_OUTPUT" ]; then
        echo "$GOFUMPT_OUTPUT"
        echo ""
        echo "❌ FORMAT FAILED: Code is not properly formatted"
        echo "   Run: gofumpt -w ."
        exit 1
    fi
    echo "✓ Format OK"

    # LINT CHECK (golangci-lint)
    echo ""
    echo "[2/3] LINT: golangci-lint run"
    if ! command -v golangci-lint &>/dev/null; then
        echo ""
        echo "❌ LINT FAILED: golangci-lint is not installed"
        echo "   Install: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
        exit 1
    fi
    if ! golangci-lint run; then
        echo ""
        echo "❌ LINT FAILED: golangci-lint found issues"
        echo "   Fix all issues before committing"
        exit 1
    fi
    echo "✓ Lint OK"

    # COVERAGE CHECK (100% required via go-test-coverage)
    echo ""
    echo "[3/3] COVERAGE: go test + go-test-coverage check"
    if ! command -v go-test-coverage &>/dev/null; then
        echo ""
        echo "❌ COVERAGE FAILED: go-test-coverage is not installed"
        echo "   Install: go install github.com/vladopajic/go-test-coverage/v2@latest"
        exit 1
    fi
    if [ ! -f .testcoverage.yml ]; then
        echo ""
        echo "❌ COVERAGE FAILED: .testcoverage.yml config not found"
        echo "   Create .testcoverage.yml with threshold: 100"
        exit 1
    fi
    if ! go test -coverprofile=coverage.out ./...; then
        echo ""
        echo "❌ COVERAGE FAILED: Tests failed"
        exit 1
    fi
    if ! go-test-coverage check --config=.testcoverage.yml; then
        echo ""
        echo "❌ COVERAGE FAILED: Coverage below threshold"
        echo "   Add tests to cover all lines"
        rm -f coverage.out
        exit 1
    fi
    rm -f coverage.out
    echo "✓ Coverage OK (100%)"
    echo ""
fi

# ═══════════════════════════════════════════════════════════════════════════════
# FLUTTER/DART
# ═══════════════════════════════════════════════════════════════════════════════
if [ -f pubspec.yaml ]; then
    echo "┌─────────────────────────────────────────────────────────────────────────────┐"
    echo "│  FLUTTER/DART QUALITY CHECKS                                                │"
    echo "└─────────────────────────────────────────────────────────────────────────────┘"

    # FORMAT CHECK (pedantic)
    echo ""
    echo "[1/3] FORMAT: dart format --set-exit-if-changed ."
    if ! dart format --set-exit-if-changed .; then
        echo ""
        echo "❌ FORMAT FAILED: Code is not properly formatted"
        echo "   Run: dart format ."
        exit 1
    fi
    echo "✓ Format OK"

    # LINT CHECK (fatal on all issues)
    echo ""
    echo "[2/3] LINT: dart analyze --fatal-infos --fatal-warnings"
    if ! dart analyze --fatal-infos --fatal-warnings; then
        echo ""
        echo "❌ LINT FAILED: Dart analyzer found issues"
        echo "   Fix all infos and warnings before committing"
        exit 1
    fi
    echo "✓ Lint OK"

    # COVERAGE CHECK (100% required)
    echo ""
    echo "[3/3] COVERAGE: flutter test --coverage (100% threshold)"
    if ! command -v flutter &>/dev/null; then
        echo ""
        echo "❌ COVERAGE FAILED: flutter is not installed"
        exit 1
    fi
    if ! command -v lcov &>/dev/null; then
        echo ""
        echo "❌ COVERAGE FAILED: lcov is not installed"
        echo "   Install: brew install lcov (macOS) or apt install lcov (Linux)"
        exit 1
    fi
    if ! flutter test --coverage; then
        echo ""
        echo "❌ COVERAGE FAILED: Tests failed"
        exit 1
    fi
    # Check coverage percentage
    COVERAGE_PCT=$(lcov --summary coverage/lcov.info 2>&1 | grep "lines" | sed 's/.*: //' | sed 's/%.*//')
    if [ -n "$COVERAGE_PCT" ]; then
        COVERAGE_INT=${COVERAGE_PCT%.*}
        if [ "$COVERAGE_INT" -lt 100 ]; then
            echo ""
            echo "❌ COVERAGE FAILED: Line coverage is ${COVERAGE_PCT}% (required: 100%)"
            echo "   Add tests to cover all lines"
            exit 1
        fi
    fi
    echo "✓ Coverage OK (100%)"
    echo ""
fi

# ═══════════════════════════════════════════════════════════════════════════════
# MARKDOWN
# ═══════════════════════════════════════════════════════════════════════════════
if command -v markdownlint-cli2 &>/dev/null; then
    if find . -name "*.md" -not -path "./node_modules/*" -not -path "./target/*" -not -path "./.git/*" -not -path "./vendor/*" -not -path "./.dart_tool/*" 2>/dev/null | grep -q .; then
        echo "┌─────────────────────────────────────────────────────────────────────────────┐"
        echo "│  MARKDOWN QUALITY CHECKS                                                    │"
        echo "└─────────────────────────────────────────────────────────────────────────────┘"
        echo ""
        echo "[1/1] LINT: markdownlint-cli2 \"**/*.md\""
        if ! markdownlint-cli2 "**/*.md"; then
            echo ""
            echo "❌ MARKDOWN LINT FAILED: Documentation has formatting issues"
            echo "   Fix all markdown issues before committing"
            exit 1
        fi
        echo "✓ Markdown OK"
        echo ""
    fi
fi

# ═══════════════════════════════════════════════════════════════════════════════
# SUCCESS
# ═══════════════════════════════════════════════════════════════════════════════
echo "════════════════════════════════════════════════════════════════════════════"
echo "  ✅ ALL QUALITY GATES PASSED"
echo "════════════════════════════════════════════════════════════════════════════"
